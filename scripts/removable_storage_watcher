#!/usr/bin/python

import sys
import gobject
import dbus

from argparse import ArgumentParser
from dbus.mainloop.glib import DBusGMainLoop


class StorageDeviceListener(object):

    def __init__(self, action, device):
        self._action = action
        self._device = device
        self._bus = dbus.SystemBus(mainloop=DBusGMainLoop())
        self._loop = gobject.MainLoop()

    def check(self, timeout):
    	if self._action == 'insert':
        	self._bus.add_signal_receiver(self.add_detected, signal_name='DeviceAdded', dbus_interface='org.freedesktop.UDisks')
    	elif self._action == 'remove':
        	self._bus.add_signal_receiver(self.remove_detected, signal_name='DeviceRemoved', dbus_interface='org.freedesktop.UDisks')

        error = False
        def timeout_callback():
            print "%s seconds have expired waiting for the device to be inserted." % timeout
            global error
            error = True
            self._loop.quit()

        gobject.timeout_add_seconds(timeout, timeout_callback)
        self._loop.run()

        return error

    def job_change_detected(self, device, job_in_progress, job_id, job_num_tasks, job_cur_task_id, job_cur_task_percentage):
        if job_id == "FilesystemMount" and self.is_device_inserted():
            print "Expected device %s inserted" % self._device
            self._loop.quit()

    def add_detected(self, added_path):
        self._bus.add_signal_receiver(self.job_change_detected, signal_name='DeviceJobChanged', dbus_interface='org.freedesktop.UDisks')

    def remove_detected(self, removed_path):
        if not self.is_device_inserted():
            print "Expected device %s has been removed" % self._device

        self._loop.quit()

    def is_device_inserted(self):
        ud_manager_obj = self._bus.get_object("org.freedesktop.UDisks", "/org/freedesktop/UDisks")
        ud_manager = dbus.Interface(ud_manager_obj, 'org.freedesktop.UDisks')

        for dev in ud_manager.EnumerateDevices():
            try:
                device_obj = self._bus.get_object("org.freedesktop.UDisks", dev)
                device_props = dbus.Interface(device_obj, dbus.PROPERTIES_IFACE)
                if not device_props.Get('org.freedesktop.UDisks.Device',"DeviceIsDrive"):
                    if device_props.Get('org.freedesktop.UDisks.Device', "DriveConnectionInterface") == self._device:
                        return True
            except dbus.DBusException:
                pass

        return False

def main():
    parser = ArgumentParser(description="Wait for the specified device to be inserted or removed.")
    parser.add_argument('action', choices=['insert','remove'])
    parser.add_argument('device', choices=['usb','firewire','sdio'])
    parser.add_argument('--timeout', type=int, default=10)
    args = parser.parse_args()

    listener = StorageDeviceListener(args.action, args.device)
    return listener.check(args.timeout)


if __name__ == "__main__":
    sys.exit(main())
