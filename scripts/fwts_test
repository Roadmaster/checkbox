#!/usr/bin/env python3

import sys
from argparse import ArgumentParser
from subprocess import Popen, PIPE

TESTS = ['acpiinfo',
         'acpitables',
         'apicedge',
         'apicinstance',
         'bios_info',
         'bios32',
         'checksum',
         'crs',
         'dmesg_common',
         'dmi_decode',
         'ebda',
         'fadt',
         'fan',
         'hda_audio',
         'hpet_check',
         'maxfreq',
         'maxreadreq',
         'mcfg',
         'microcode',
         'mtrr',
         'nx',
         'os2gap',
         'osilinux',
         'smbios',
         'version',
         'virt',
         'wmi',
         'cstates',
         'dmar']


def main():
    parser = ArgumentParser(description='Tests the system BIOS using the \
                            Firmware Test Suite')
    group = parser.add_mutually_exclusive_group()
    group.add_argument('-c', '--cpufreq',
                      action='store_true',
                      help=('Chose this option to run '
                            'the CPU Frequency Scaling test only'))
    group.add_argument('-w', '--wakealarm',
                      action='store_true',
                      help='Run the fwts wakealarm test only')
    parser.add_argument('-a', '--all',
                      action='store_true',
                      help='Run ALL FWTS automated tests (assumes -w and -c)')
    parser.add_argument('-l', '--log',
                      default='/tmp/fwts_results.log',
                      help=('Specify the location and name of the log file. '
                            '[Default: %(default)s]'))
    args = parser.parse_args()

    tests = []
    results = {}
    critical_fails = []
    high_fails = []
    medium_fails = []
    low_fails = []

    if args.cpufreq:
        tests += ['cpufreq']
    elif args.wakealarm:
        tests += ['wakealarm']
    elif args.all:
        tests += ['wakealarm', 'cpufreq'] + TESTS
    else:
        tests += TESTS

    # run the tests we want
    for test in tests:
        command = ('fwts -q --stdout-summary -r %s %s'
                   % (args.log, test))
        results[test] = (Popen(command, stdout=PIPE, shell=True)
                         .communicate()[0].strip()).decode()

    # parse the summaries
    passed = 0
    critical_count = 0
    high_count = 0
    medium_count = 0
    low_count = 0

    for test in tests:
        if results[test] == 'FAILED_CRITICAL':
            critical_count += 1
            critical_fails += [test]
        elif results[test] == 'FAILED_HIGH':
            high_count += 1
            high_fails += [test]
        elif results[test] == 'FAILED_MEDIUM':
            medium_count += 1
            medium_fails += [test]
        elif results[test] == 'FAILED_LOW':
            low_count += 1
            low_fails += [test]
        elif results[test] == 'PASSED':
            passed += 1
        else:
            continue
    
    if critical_count:
        print("Critical Failures: %d" % critical_count)
        for test in critical_fails: print(" - " + test)
    if high_count:
        print("High Failures: %d" % high_count)
        for test in high_fails: print(" - " + test)
    if medium_count:
        print("Medium Failures: %d" % medium_count)
        for test in medium_fails: print(" - " + test)
    if low_count:    
        print("Low Failures: %d" % low_count)
        for test in low_fails: print(" - " + test)
    print("Passed: %d" % passed)

    if critical_count != 0 or high_count != 0:
        return 1
    else:
        return 0

if __name__ == '__main__':
    sys.exit(main())
